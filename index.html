<!doctype html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport"
        content="width=device-width, user-scalable=no, initial-scale=1.0, maximum-scale=1.0, minimum-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <title>Zelda's Road</title>
    <style type="text/css">
        body {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
        }
    </style>
</head>

<body>
    <canvas id="myCanvas" width="600" height="600" style="background-color: lightgray;">Tu navegador no soporta
        canvas</canvas>
    <!-- <img src="./logo_uabcs.png" width="100" height="100" id="imagen"> -->
    <script>
        let canvas = document.getElementById("myCanvas");
        let ctx = canvas.getContext("2d");
        let dir = 0, speed = 5, score = 0, level = 2;
        let pause = false, loses = false, gameoverAntiLoop = false, start = false;
        let startPosition = [
            x = 300,
            y = 550,
        ];
        //level
        let music = new Audio();
        let gameover = new Audio();
        music.src = "./src/assets/sounds/background-music.mp3";
        gameover.src = "./src/assets/sounds/gameover.mp3";
        //Deku
        let dekuscrub = new Image();
        let deku_nut = new Image();
        let dekuscrib_spit = new Audio();
        dekuscrub.src = "./src/assets/images/dekuscrub.png";
        deku_nut.src = "./src/assets/images/deku-nut.png";
        dekuscrib_spit.src = "./src/assets/sounds/dekuscrub_spit.mp3";
        //Link
        let link = new Image();
        let link_step = new Audio();
        let link_dies = new Audio();
        link.src = "./src/assets/images/link.png";
        link_step.src = "./src/assets/sounds/link_step.mp3";
        link_dies.src = "./src/assets/sounds/link_dies.mp3";
        //Rupee
        let rupia = new Image();
        let rupiaSound = new Audio();
        rupia.src = "./src/assets/images/rupia.png";
        rupiaSound.src = "./src/assets/sounds/rupee_sound.mp3";
        //Piedra sheika
        let piedraSheika = new Image();
        piedraSheika.src = "./src/assets/images/piedra-sheika.png";
        class Rectangulo {
            constructor(alto, ancho, x, y, color) {
                this.alto = alto;
                this.ancho = ancho;
                this.x = x;
                this.y = y;
                this.color = color;
            }
            seTocan(target) {
                if (this.x < target.x + target.ancho &&
                    this.x + this.ancho > target.x &&
                    this.y < target.y + target.alto &&
                    this.y + this.alto > target.y) {
                    return true;
                }
                return false;
            }
            paint(ctx) {
                ctx.fillStyle = this.color;
                ctx.fillRect(this.x, this.y, this.ancho, this.alto);
            }
        }
        class DekuScrub extends Rectangulo {
            constructor(alto, ancho, x, y, color, type) {
                super(alto, ancho, x, y, color);
                this.type = type;
            }
        }
        class Nut extends Rectangulo {
            constructor(alto, ancho, x, y, color, speed) {
                super(alto, ancho, x, y, color);
                this.speed = speed;
            }
            reiniciarPosicion(initX) {
                this.x = initX;
            }
        }
        let wallscolor = "#70865e"
        const muros = [];
        muros.push(new Rectangulo(600, 50, 0, 0, wallscolor));
        muros.push(new Rectangulo(600, 50, 550, 0, wallscolor));
        muros.push(new Rectangulo(40, 600, 0, 600, wallscolor));
        muros.push(new Rectangulo(40, 600, 0, 0, wallscolor));

        const piedras = [];

        const enemies = [
            [
                new DekuScrub(40, 40, 555, 100, "gray", 'Strong'),
                new DekuScrub(40, 40, 555, 200, "gray", 'Normal'),
                new DekuScrub(40, 40, 555, 300, "gray", 'Weak'),
            ],
            [
                new DekuScrub(40, 40, 555, 100, "gray", 'Strong'),
                new DekuScrub(40, 40, 555, 200, "gray", 'Strong'),
                new DekuScrub(40, 40, 555, 300, "gray", 'Normal'),
                new DekuScrub(40, 40, 555, 400, "gray", 'Normal'),
                new DekuScrub(40, 40, 555, 500, "gray", 'Strong'),
            ],
            [
                new DekuScrub(40, 40, 555, 100, "gray", 'Strong'),
                new DekuScrub(40, 40, 555, 200, "gray", 'Strong'),
                new DekuScrub(40, 40, 555, 300, "gray", 'Strong'),
            ],
        ];
        console.log(enemies);
        /* enemies.push(new DekuScrub(40, 40, 555, 100, "gray", 'Strong'));
        enemies.push(new DekuScrub(40, 40, 555, 200, "gray", 'Normal'));
        enemies.push(new DekuScrub(40, 40, 555, 300, "gray", 'Weak')); */
        const nuts = [];
        //Generar nueces
        enemies[level - 1].forEach(enemy => {
            switch (enemy.type) {
                case 'Strong':
                    speed = 5;
                    break;
                case 'Normal':
                    speed = 4;
                    break;
                case 'Weak':
                    speed = 3;
                    break;

            }
            nuts.push(new Nut(enemy.alto, enemy.ancho, enemy.x, enemy.y, "gray", speed));
        });
        const player = new Rectangulo(50, 50, 300, 550, "black");
        const coin = new Rectangulo(40, 30, 350, 350, "black");
        document.addEventListener("keydown", (e) => {
            start = true;
            music.play();
            console.log(e.keyCode);
            //x = Math.floor(Math.random() * 600), y = Math.floor(Math.random() * 600);
            /* console.log(e.keyCode); */
            switch (e.keyCode) {
                case 87: case 38://w
                    if (!pause) {
                        link_step.play();
                        if ((player.y - 50) < 0) { return }
                        player.y -= 50;
                    };
                    break;
                case 65: case 37://a
                    if (!pause) {
                        link_step.play();
                        if ((player.x - 50) < 50) { return }
                        player.x -= 50;
                    };
                    break;
                case 83: case 40://s
                    if (!pause) {
                        link_step.play();
                        if ((player.y + 50) > 570) { return }
                        player.y += 50;
                    };
                    break;
                case 68: case 39://d
                    if (!pause) {
                        link_step.play();
                        if ((player.x + 50) > 520) { return }
                        player.x += 50;
                    };
                    break;
                case 32://Spacebar
                    if (!loses) pause = !pause;
                    break;
                case 82: case 114:
                    restart();
                    break;
            }
        })
        function update() {
            if (!pause) {
                if (start) {
                    for (let i = 0; i < enemies[level - 1].length; i++) {
                        if ((nuts[i].x - 5) > 50)
                            nuts[i].x -= nuts[i].speed;
                        else {
                            nuts[i].x = 560;
                            dekuscrib_spit.play();
                        }
                        //player hit
                        if (player.seTocan(nuts[i])) {
                            link_dies.play();
                            loses = true;
                            pause = true
                        }
                    }
                }
                if (player.seTocan(coin)) {
                    rupiaSound.play();
                    coin.x = Math.random() * 560;
                    coin.y = Math.random() * 560;
                    score += 10;
                }

            }
            repaint();
            window.requestAnimationFrame(update);
        }
        function repaint() {
            if (!pause) {
                ctx.fillStyle = "#ede1b5";
                ctx.fillRect(0, 0, 600, 600);
                muros.forEach(muro => {
                    muro.paint(ctx);
                });
                ctx.beginPath();
                ctx.font = "30px verdana";
                ctx.fillStyle = 'black';
                ctx.fillText("Score:" + score, 10, 30);
                ctx.font = "30px verdana";
                ctx.fillStyle = 'black';
                ctx.fillText("Level:" + level, 250, 30);

                //player.paint(ctx);
                ctx.drawImage(link, player.x, player.y, player.ancho, player.alto);
                //coin.paint(ctx);
                ctx.drawImage(rupia, coin.x, coin.y, coin.ancho, coin.alto);
                enemies[level - 1].forEach(enemy => {
                    ctx.drawImage(dekuscrub, enemy.x, enemy.y, enemy.ancho, enemy.alto);
                });
                for (let i = 0; i < enemies[level - 1].length; i++) {
                    ctx.drawImage(deku_nut, nuts[i].x, nuts[i].y + 20, nuts[i].ancho / 2, nuts[i].alto / 2);
                }

                ctx.stroke();
                ctx.fill();
                ctx.closePath();
            } else {
                if (loses) {
                    music.pause();
                    if (!gameoverAntiLoop) {
                        gameover.play();
                    }
                    gameoverAntiLoop = true;
                    ctx.fillStyle = "rgba(0, 0, 0, 0.02)";
                    ctx.fillRect(0, 0, 600, 600);

                    ctx.font = "30px verdana";
                    ctx.strokeStyle = 'red';
                    ctx.strokeText("Game over", 220, 300);
                    ctx.fillStyle = 'orange';
                    ctx.fillText("Game over", 220, 300);
                    ctx.strokeStyle = "";
                    ctx.font = "16px verdana";
                    ctx.fillStyle = 'white';
                    ctx.fillText('Presiona la tecla "R" para volver a intentar.', 140, 350);
                } else {
                    ctx.fillStyle = "rgba(122, 122, 122, 0.02)";
                    ctx.fillRect(0, 0, 600, 600);

                    ctx.font = "30px verdana";
                    ctx.fillStyle = 'white';
                    ctx.fillText("Pause", 270, 300);
                }
            }
        }
        function restart() {

            //Reiniciar posicion nueces
            for (let i = 0; i < enemies[level - 1].length; i++) {
                nuts[i].reiniciarPosicion(enemies[level - 1][i].x);
            }
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            level = 1;
            score = 0;
            loses = false;
            pause = false;
            gameoverAntiLoop = false;
            gameover.pause();
            link_dies.pause();
            player.x = startPosition[0];
            player.y = startPosition[1];
        }
        function random_rgba() {
            var o = Math.round, r = Math.random, s = 255;
            return 'rgba(' + o(r() * s) + ',' + o(r() * s) + ',' + o(r() * s) + ',' + r().toFixed(1) + ')';
        }
        window.requestAnimationFrame = (function () {
            return window.requestAnimationFrame ||
                window.webkitRequestAnimationFrame ||
                window.mozRequestAnimationFrame ||
                function (callback) {
                    window.setTimeout(callback, 17);
                };
        }());
        window.requestAnimationFrame(update);
    </script>
</body>

</html>